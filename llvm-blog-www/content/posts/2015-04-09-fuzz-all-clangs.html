---
author: Kostya Serebryany
blogger_id: tag:blogger.com,1999:blog-6088150582281556517.post-685876696445070696
blogger_orig_url: http://blog.llvm.org/2015/04/fuzz-all-clangs.html
date: "2015-04-09T13:40:00Z"
modified_time: "2015-04-09T14:06:53.150-07:00"
tags: ["sanitizer","testing","Clang"]
title: Simple guided fuzzing for libraries using LLVM's new libFuzzer
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><br /></div><span style="color: black; font-family: Arial; font-size: 15px; vertical-align: baseline; white-space: pre-wrap;">Fuzzing (or <a href="http://en.wikipedia.org/wiki/Fuzz_testing">fuzz testing</a></span><span style="color: black; font-family: Arial; font-size: 15px; vertical-align: baseline; white-space: pre-wrap;">) is becoming increasingly popular. Fuzzing Clang and fuzzing </span><span style="color: black; font-family: Arial; font-size: 15px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;">with</span><span style="color: black; font-family: Arial; font-size: 15px; vertical-align: baseline; white-space: pre-wrap;"> Clang is not new: Clang-based <a href="http://clang.llvm.org/docs/AddressSanitizer.html">AddressSanitizer</a></span><span style="color: black; font-family: Arial; font-size: 15px; vertical-align: baseline; white-space: pre-wrap;"> has been used for fuzz-testing the Chrome browser for <a href="http://blog.chromium.org/2012/04/fuzzing-for-security.html">several years</a></span><span style="color: black; font-family: Arial; font-size: 15px; vertical-align: baseline; white-space: pre-wrap;"> and Clang itself has been extensively fuzzed using <a href="https://embed.cs.utah.edu/csmith/">csmith</a> </span><span style="color: black; font-family: Arial; font-size: 15px; vertical-align: baseline; white-space: pre-wrap;">and, more recently, using <a href="http://lcamtuf.coredump.cx/afl/">AFL</a>.</span><span style="color: black; font-family: Arial; font-size: 15px; vertical-align: baseline; white-space: pre-wrap;"> Now we’ve closed the loop and started to fuzz parts of LLVM (including Clang) using LLVM itself.</span><br /><br /><span style="color: black; font-family: Arial; font-size: 15px; line-height: 1.38; vertical-align: baseline; white-space: pre-wrap;"><a href="http://llvm.org/docs/LibFuzzer.html">LibFuzzer</a></span><span style="color: black; font-family: Arial; font-size: 15px; line-height: 1.38; vertical-align: baseline; white-space: pre-wrap;">, recently added to the LLVM tree, is a library for in-process fuzzing that uses <a href="https://code.google.com/p/address-sanitizer/wiki/AsanCoverage">Sanitizer Coverage instrumentation</a></span><span style="color: black; font-family: Arial; font-size: 15px; line-height: 1.38; vertical-align: baseline; white-space: pre-wrap;"> to guide test generation. </span><span style="font-family: Arial; font-size: 15px; line-height: 1.38; vertical-align: baseline; white-space: pre-wrap;">With LibFuzzer one can implement a guided fuzzer for some library by writing one simple function:&nbsp;</span><br /><div dir="ltr" style="margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Courier New, Courier, monospace;">extern "C" void TestOneInput(const uint8_t *Data, size_t Size);</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"><br /></span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">We have implemented two fuzzers on top of LibFuzzer: <a href="http://llvm.org/viewvc/llvm-project/cfe/trunk/tools/clang-format/fuzzer/ClangFormatFuzzer.cpp?view=markup">clang-format-fuzzer</a></span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> and <a href="http://llvm.org/viewvc/llvm-project/cfe/trunk/tools/clang-fuzzer/ClangFuzzer.cpp?view=markup">clang-fuzzer</a></span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">. </span><span style="color: black; font-family: Arial; font-size: 15px; vertical-align: baseline; white-space: pre-wrap;">Clang-format is mostly a lexical analyzer, so giving it random bytes to format worked perfectly and discovered <a href="https://llvm.org/bugs/show_bug.cgi?id=23052">over 20 bugs</a></span><span style="color: black; font-family: Arial; font-size: 15px; vertical-align: baseline; white-space: pre-wrap;">. Clang however is more than just a lexer and giving it random bytes barely scratches the surface, so in addition to testing with random bytes we also fuzzed Clang in <a href="http://llvm.org/docs/LibFuzzer.html#tokens">token-aware mode</a></span><span style="color: black; font-family: Arial; font-size: 15px; vertical-align: baseline; white-space: pre-wrap;">.&nbsp;Both modes found <a href="https://llvm.org/bugs/show_bug.cgi?id=23057">bugs</a></span><span style="color: black; font-family: Arial; font-size: 15px; vertical-align: baseline; white-space: pre-wrap;">; some of them were previously <a href="http://lists.cs.uiuc.edu/pipermail/cfe-dev/2015-January/040705.html">detected </a></span><span style="color: black; font-family: Arial; font-size: 15px; vertical-align: baseline; white-space: pre-wrap;"><a href="http://lists.cs.uiuc.edu/pipermail/cfe-dev/2015-January/040705.html">by AFL</a>, some others were not: we’ve run this fuzzer with AddressSanitizer and some of the bugs are not easily discoverable without it.</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"><br /></span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Just to give you the feeling, here are some of the input samples discovered by the token-aware clang-fuzzer starting from an empty test corpus: </span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> &nbsp;static void g(){}</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> &nbsp;signed*Qwchar_t;</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> &nbsp;overridedouble++!=~;inline-=}y=^bitand{;*=or;goto*&amp;&amp;k}==n</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> &nbsp;int XS/=~char16_t&amp;s&lt;=const_cast&lt;Xchar*&gt;(thread_local3+=char32_t </span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"><br /></span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Fuzzing is not a one-off thing -- it shines when used continuously. We have set up a <a href="http://lab.llvm.org:8011/builders/sanitizer-x86_64-linux-fuzzer">public build bot</a></span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> that runs clang-fuzzer and clang-format-fuzzer 24/7. This way, the fuzzers keep improving the test corpus and will periodically find old bugs or fresh regressions (the bot has <a href="http://reviews.llvm.org/D7871">caught</a> at least one such regression already</span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">). </span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"><br /></span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">The benefit of in-process fuzzing compared to out-of-process is that you can test more inputs per second. This is also a weakness: you can not effectively limit the execution time for every input. If some of the inputs trigger superlinear behavior, it may slow down or paralyze the fuzzing. Our fuzzing bot was nearly dead after it discovered <a href="https://llvm.org/bugs/show_bug.cgi?id=23052#c3">exponential parsing time in clang-format</a></span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">. You can workaround the problem by setting a timeout for the fuzzer, but it’s always better to fix superlinear behavior.</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"><br /></span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">It would be interesting to fuzz other parts of LLVM, but a requirement for in-process fuzzing is that the library does not crash on invalid inputs. This holds for clang and clang-format, but not for, e.g., the LLVM bitcode reader. </span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"><br /></span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Help is more than welcome! You can start by fixing one of the existing bugs in clang or clang-format (see <a href="https://llvm.org/bugs/show_bug.cgi?id=23057">PR23057</a>, <a href="https://llvm.org/bugs/show_bug.cgi?id=23052">PR23052</a> and the <a href="http://sli.dy.fi/~sliedes/clang-triage/triage_report.xhtml">results from AFL</a>)</span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> or write your own fuzzer for some other part of LLVM or profile one of the existing fuzzers and try to make it faster by fixing performance bugs. </span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"><br /></span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Of course, LibFuzzer can be used to test things outside of the LLVM project. As an example, and following <a href="https://blog.hboeck.de/archives/868-How-Heartbleed-couldve-been-found.html">Hanno Böck’s blog post</a></span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> on <a href="http://en.wikipedia.org/wiki/Heartbleed">Heartbleed</a></span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">, we’ve applied LibFuzzer to <a href="https://www.openssl.org/">openssl</a> </span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">and found Heartbleed in <a href="http://llvm.org/docs/LibFuzzer.html#heartbleed">less than a minute</a></span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">. Also, quite a few new bugs have been discovered in <a href="http://www.pcre.org/">PCRE2</a></span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> (<a href="http://www.exim.org/viewvc/pcre2/code/trunk/ChangeLog?r1=228&amp;r2=227&amp;pathrev=228">1</a>, <a href="http://www.exim.org/viewvc/pcre2/code/trunk/ChangeLog?r1=231&amp;r2=230&amp;pathrev=231">2</a>, <a href="http://www.exim.org/viewvc/pcre2?view=revision&amp;revision=232">3</a>, <a href="http://www.exim.org/viewvc/pcre2/code/trunk/ChangeLog?r1=233&amp;r2=232&amp;pathrev=233">4</a>, <a href="http://www.exim.org/viewvc/pcre2/code/trunk/ChangeLog?r1=234&amp;r2=233&amp;pathrev=234">5</a>, <a href="http://www.exim.org/viewvc/pcre2/code/trunk/ChangeLog?r1=235&amp;r2=234&amp;pathrev=235">6</a>, <a href="http://www.exim.org/viewvc/pcre2/code/trunk/ChangeLog?r1=236&amp;r2=235&amp;pathrev=236">7</a>, <a href="http://www.exim.org/viewvc/pcre2/code/trunk/ChangeLog?r1=237&amp;r2=236&amp;pathrev=237">8</a>, <a href="http://www.exim.org/viewvc/pcre2/code/trunk/ChangeLog?r1=238&amp;r2=237&amp;pathrev=238">9</a>, <a href="http://www.exim.org/viewvc/pcre2/code/trunk/ChangeLog?r1=241&amp;r2=240&amp;pathrev=241">10</a>, <a href="http://www.exim.org/viewvc/pcre2/code/trunk/ChangeLog?r1=244&amp;r2=243&amp;pathrev=244">11</a>), <a href="https://sourceware.org/glibc/wiki/FuzzingLibc">Glibc</a> </span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">and <a href="http://musl-libc.org/">MUSL libc</a> (<a href="http://git.musl-libc.org/cgit/musl/patch/?id=39dfd58417ef642307d90306e1c7e50aaec5a35c">1</a>, <a href="http://git.musl-libc.org/cgit/musl/patch/?id=fc13acc3dcb5b1f215c007f583a63551f6a71363">2</a>)</span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> .</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"><br /></span><span style="background-color: transparent; color: black; font-family: Arial; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Fuzz testing, especially coverage-directed and sanitizer-aided fuzz testing, should directly compliment unit testing, integration testing, and system functional testing. We encourage everyone to start actively fuzz testing their interfaces, especially those with even a small chance of being subject to attacker-controlled inputs. We hope the LLVM fuzzing library helps you start leveraging our tools to better test your code, and let us know about any truly exciting bugs they help you find!</span></div></div>
